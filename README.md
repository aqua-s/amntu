# amntu

amnut.shは、USBメモリなどのリムーバブルメディアを接続した際に、マウン
トするかどうか、するならRead-Onlyとするかどうかを確認するダイアログを
出すbashのスクリプトです。

## 背景

私は、自宅のプライベートな環境ではLinuxで稼働するPCを常用しています。
Linuxでも、USBメモリなどのリムーバブルメディアを接続すると/run/mediaの
ようなディレクトリに自動的にマウントする機能はよくあります。

しかし、私はOSの用意する自動マウント機能を停止させています。マウントす
ること自体によってメディアが書き換えられてしまうことがあります。それを
避けるためにRead-Onlyでマウントしたいことがよくあるからです。

ただそれはそれで、事前に色々と準備をするか、マウントの度にrootになる必
要があるなど面倒なことも多くなります。そこで、メディア接続時にダイアロ
グを表示し、マウントするかどうか、するならRead-Onlyかどうかを選択でき
るような機能が欲しいと思い、とりあえずは馴染みのあるbashのシェルスクリ
プトで作ってみました。

## 仕組み

bashのスクリプトです。
<a href="https://wiki.archlinux.org/index.php/Udisks" title="Udisks - ArchWiki" target="_blank">Udisks - ArchWiki</a>
及び
<a href="https://wiki.archlinux.jp/index.php/Udisks" title="Udisks - ArchWiki" target="_blank">Udisks - ArchWiki (日本語)</a>
にあるサンプルスクリプトを参考に作りました。

udevadmを起動して常駐し、その出力からメディアの接続を検出して、容量な
どメディアに関する簡単な情報を表示したうえで、通常のマウント、
Read-Onlyのマウント、もしくは何もしないのいずれかを選択できるようにし
ています。

ダイアログの出力には
<a href="https://github.com/v1cont/yad" title="GitHub - v1cont/yad: Yet Another Dialog" target="_blank">v1cont/yad: Yet Another Dialog</a>
を使用しています。現在の版では、見栄えに関してはほぼ全く配慮をしていな
いので、極めて無味乾燥なものになっています。

## 参考

スクリプトの記法については、説明しておいた方が良さそうな箇所がいくつか
あるので、以下に記します。

- SIGUSR1の処理について  
bashのスクリプトは、動作中に書き換えるとエラー終了してしまう
ことがあるので、その回避のために使用しています。  
具体的には、ファイルを置き換える際には使用中のスクリプトは
mv（rename）により別の名前にした上で新しいものを同じ名前で同じ場所に
置くようにすることとします。その後にSIGUSR1を送ると、
関数ReDo()により最初と同じコマンドラインでexecするようにしています。  
cmd, argsの変数はそのために設定しています。
- 変数DevInfo_\*  
udevadmの出力結果を保持する変数は、すべてこの文字列で始まる名前にして
います。名前空間のようなものですね。それにより、一気に
該当する変数のみunsetすることもできます。  
ただし、\*の部分として_NAME, _RMは特別に使用しています。
- リムーバブルメディア  
上記_RMはリムーバブルメディアかどうかを保持しますが、判断方法は
util-linuxのlsblkコマンドのソースを参考にしました。
- $'...'  
udevadmの出力は、空白で区切った複数の要素に分かれていることがあるので、
'...'で囲んでから格納しています。  
また、\\xNNでエンコードされている場合もあるので、単なる'...'でなく
$'...'を使用しています。
- udevadmの呼び出し（関数SetDevInfo()内）  
udevadm infoの結果を元に変数を設定するのですが、パイプを使用するとそれ
は別のプロセスになるため、終了すると変数の値が失われてしまいます。その
ため、<(...)を使用しています。
- udevadmの呼び出し（メインループ）  
パイプにしてもいいのですが、そうするとamntu.shのプロセスが二つになって
しまって少し無駄な感じがするので、coprocとしました。  
なお、こちらで<(...)を使用していないことに、特に意味はありません。

## TODO

- ダイアログの見栄えをもう少しマシなものにしたい。
- ro以外のマウントオプションも指定できるようにしたい（ダイアログで
マウントのオプションを編集できるようにするなど）。
- CD-ROM等に対応できるか？

## 一言

実は、このリポジトリはGitHubの練習用に作成したものです。公開している
amntu.shは、自分では実際に使用しているものの他の人にとって実用になる
かというと微妙ですが、練習には手頃かなと思い選びました。
